(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/bookshelf/bookshelf"],{1159:function(e,t,n){"use strict";var o;n.d(t,"b",(function(){return a})),n.d(t,"c",(function(){return s})),n.d(t,"a",(function(){return o}));var a=function(){var e=this,t=e.$createElement;e._self._c;e._isMounted||(e.e0=function(t){e.showShareMenu=!0})},s=[]},1839:function(e,t,n){},"19c7":function(e,t,n){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var o=s(n("a34a")),a=s(n("abb0"));function s(e){return e&&e.__esModule?e:{default:e}}function i(e,t,n,o,a,s,i){try{var c=e[s](i),r=c.value}catch(l){return void n(l)}c.done?t(r):Promise.resolve(r).then(o,a)}function c(e){return function(){var t=this,n=arguments;return new Promise((function(o,a){var s=e.apply(t,n);function c(e){i(s,o,a,c,r,"next",e)}function r(e){i(s,o,a,c,r,"throw",e)}c(void 0)}))}}var r=function(){n.e("components/pubpage").then(function(){return resolve(n("00e9"))}.bind(null,n)).catch(n.oe)},l=function(){n.e("components/pubshare").then(function(){return resolve(n("7a80"))}.bind(null,n)).catch(n.oe)},u=function(){n.e("components/pub-ui/bookcell").then(function(){return resolve(n("dd81"))}.bind(null,n)).catch(n.oe)},f={components:{pubpage:r,bookcell:u,pubshare:l},data:function(){return{title:"",isEditing:!1,shelfInfo:null,shelfid:null,canloadmore:!0,showShareMenu:!1,isBooksLen:!1,books:[]}},onLoad:function(t){this.shelfid=t.id,this.shelfid||e.navigateBack(),this.getShelfInfo(),this.requestBookList()},onReachBottom:function(){this.requestBookList(this.books[this.books.length-1]._id)},onShareAppMessage:function(){return{title:this.title,path:"/pages/me/index?scene=sid="+this.shelfInfo._id}},methods:{drawPoster:function(){var t=this;e.showLoading({title:"生成中",mask:!0});var n=wx.createSelectorQuery();n.select("#myPoster").fields({node:!0,size:!0}).exec(function(){var n=c(o.default.mark((function n(s){var i,c,r,l,u,f,d,h;return o.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return i=s[0].node,c=i.getContext("2d"),r=e.getSystemInfoSync().pixelRatio,i.width=s[0].width*r,i.height=s[0].height*r,c.scale(r,r),c.fillStyle="#ffffff",c.fillRect(0,30,350,750),c.fillStyle="black",c.fontSize=20,c.fillText("用户名："+t.shelfInfo.ownerinfo.nickName,70,50),c.fontSize=20,c.fillText("书房名："+t.shelfInfo.name,70,65),c.fontSize=20,c.fillText("地址："+t.shelfInfo.address,70,80),l=i.createImage(),l.onload=function(e){c.drawImage(l,10,35,50,50)},l.src=t.shelfInfo.ownerinfo.avatarUrl,u=Math.min(t.books.length,9),f=0,d=function n(){var o=t.books[f];console.log(t.books),t.books.length<1?e.showModal({content:"无图书分享",showCancel:!1}):e.getImageInfo({src:o.cover_url,success:function(t){var a=i.createImage();a.onload=function(){var t=115*Math.floor(f%3)+10,s=165*Math.floor(f/3)+100;c.drawImage(a,t,s,100,150),c.fontSize=16,c.fillText(o.title,t+5,s+165),f<u-1?(f++,n()):(console.log("全部封面加载结束"),e.hideLoading(),e.canvasToTempFilePath({canvas:i,success:function(t){e.previewImage({current:t.tempFilePath,urls:[t.tempFilePath]})},fail:function(e){console.log(e)}}))},a.src=t.path}})},n.next=23,a.default.call({name:"getwxacode",data:{scene:"sid="+t.shelfInfo._id}});case 23:h=n.sent,console.log(h),wx.getFileSystemManager().writeFileSync("".concat(wx.env.USER_DATA_PATH,"/mpcode.jpg"),e.arrayBufferToBase64(h.result.data),"base64"),e.getImageInfo({src:"".concat(wx.env.USER_DATA_PATH,"/mpcode.jpg"),success:function(e){var t=i.createImage();t.onload=function(e){c.drawImage(t,180,580,160,160),d()},t.src=e.path}});case 27:case"end":return n.stop()}}),n)})));return function(e){return n.apply(this,arguments)}}())},onShareSelected:function(e){1==e&&this.drawPoster()},onShareDismiss:function(){this.showShareMenu=!1},getShelfInfo:function(){var e=this;a.default.call({name:"bookshelfs",data:{action:"get",_id:this.shelfid},success:function(t){console.log(t.result),e.shelfInfo=t.result}})},requestBookList:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;t&&!this.canloadmore||a.default.call({name:"books",data:{action:"listbyshelf",shelfid:this.shelfid,start:t},success:function(n){e.canloadmore=n.result.length>=9,e.books=t?e.books.concat(n.result):n.result,e.books<1?e.isBooksLen=!0:e.isBooksLen=!1}})},btnDeleteBook:function(t){var n=this;console.log(t.currentTarget.dataset.id),e.showActionSheet({itemList:["置顶","删除"],success:function(e){0==e.tapIndex?a.default.call({name:"books",data:{action:"movetop",bookid:t.currentTarget.dataset.id},success:function(e){n.requestBookList()}}):1==e.tapIndex&&a.default.call({name:"books",data:{action:"delete",shelfid:n.shelfid,bookid:t.currentTarget.dataset.id},success:function(e){n.requestBookList()}})}})},btnExitEditing:function(){this.isEditing=!1},btnEnterEditing:function(){this.isEditing=!0},btnScan:function(){var t=this;e.scanCode({success:function(){var e=c(o.default.mark((function e(n){var s;return o.default.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,a.default.call({name:"ISBNQuery",data:{isbn:n.result}});case 2:return s=e.sent,e.next=5,a.default.call({name:"books",data:{action:"add",shelfid:t.shelfid,isbnid:s.result._id}});case 5:t.requestBookList();case 6:case"end":return e.stop()}}),e)})));function n(t){return e.apply(this,arguments)}return n}(),fail:function(t){console.log("扫码失败",t),e.showModal({content:"扫码失败,请重新尝试",showCancel:!1})}})}}};t.default=f}).call(this,n("543d")["default"])},6360:function(e,t,n){"use strict";(function(e){n("efbb");o(n("66fd"));var t=o(n("716a"));function o(e){return e&&e.__esModule?e:{default:e}}wx.__webpack_require_UNI_MP_PLUGIN__=n,e(t.default)}).call(this,n("543d")["createPage"])},"716a":function(e,t,n){"use strict";n.r(t);var o=n("1159"),a=n("d74f");for(var s in a)"default"!==s&&function(e){n.d(t,e,(function(){return a[e]}))}(s);n("f74a");var i,c=n("f0c5"),r=Object(c["a"])(a["default"],o["b"],o["c"],!1,null,null,null,!1,o["a"],i);t["default"]=r.exports},d74f:function(e,t,n){"use strict";n.r(t);var o=n("19c7"),a=n.n(o);for(var s in o)"default"!==s&&function(e){n.d(t,e,(function(){return o[e]}))}(s);t["default"]=a.a},f74a:function(e,t,n){"use strict";var o=n("1839"),a=n.n(o);a.a}},[["6360","common/runtime","common/vendor"]]]);