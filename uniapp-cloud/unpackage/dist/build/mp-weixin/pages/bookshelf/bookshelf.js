(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/bookshelf/bookshelf"],{"155e":function(e,t,n){"use strict";n.r(t);var o=n("4c73"),i=n.n(o);for(var a in o)"default"!==a&&function(e){n.d(t,e,(function(){return o[e]}))}(a);t["default"]=i.a},"3d76":function(e,t,n){"use strict";n.d(t,"b",(function(){return i})),n.d(t,"c",(function(){return a})),n.d(t,"a",(function(){return o}));var o={uniTag:function(){return n.e("node-modules/@dcloudio/uni-ui/lib/uni-tag/uni-tag").then(n.bind(null,"b9d4"))}},i=function(){var e=this,t=e.$createElement;e._self._c;e._isMounted||(e.e0=function(t){e.showShareMenu=!0})},a=[]},"4c73":function(e,t,n){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var o=l(n("a34a")),i=l(n("cc50")),a=l(n("8a0b")),s=n("26cb");function l(e){return e&&e.__esModule?e:{default:e}}function c(e,t,n,o,i,a,s){try{var l=e[a](s),c=l.value}catch(r){return void n(r)}l.done?t(c):Promise.resolve(c).then(o,i)}function r(e){return function(){var t=this,n=arguments;return new Promise((function(o,i){var a=e.apply(t,n);function s(e){c(a,o,i,s,l,"next",e)}function l(e){c(a,o,i,s,l,"throw",e)}s(void 0)}))}}function u(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function f(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?u(Object(n),!0).forEach((function(t){d(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):u(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function d(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var h=function(){n.e("components/pubpage").then(function(){return resolve(n("36f3"))}.bind(null,n)).catch(n.oe)},g=function(){n.e("components/pubshare").then(function(){return resolve(n("9f9a"))}.bind(null,n)).catch(n.oe)},b=function(){n.e("components/pub-ui/bookcell").then(function(){return resolve(n("a81b"))}.bind(null,n)).catch(n.oe)},p={components:{pubpage:h,bookcell:b,pubshare:g},data:function(){return{title:"",isEditing:!1,shelfInfo:null,shelfid:null,canloadmore:!0,showShareMenu:!1,isBooksLen:!1,isCanvas:!1,books:[],follow:{isExi:!1,loading:!0,inverted:!1,text:"未关注"}}},computed:f({},(0,s.mapGetters)(["token"])),watch:{books:function(e){this.isBooksLen=e<1},"shelfInfo.isowner":{handler:function(e){var t=this;this.follow.isExi=!e,e||i.default.call({name:"updataFolow",data:{action:"get",token:this.token,_id:this.shelfid},success:function(e){console.log(e),t.follow.loading=!1,t.follow.inverted=e.result.state}})}},"follow.inverted":{handler:function(e){this.follow.text=e?"已关注":"未关注"}}},onLoad:function(t){this.shelfid=t.id,this.shelfid||e.navigateBack(),this.getShelfInfo(),this.requestBookList()},onReachBottom:function(){this.requestBookList(this.books[this.books.length-1]._id)},onShareAppMessage:function(){return{title:this.title,path:"/pages/me/index?scene=sid="+this.shelfInfo._id}},methods:{setFollow:function(){var t=this;this.follow.loading||(this.follow.inverted?(this.follow.loading=!0,e.showModal({content:"确定取消关注吗?",success:function(n){n.confirm&&(t.follow.loading=!0,i.default.call({name:"updataFolow",data:{action:"delete",token:t.token,_id:t.shelfid},success:function(n){console.log(n),t.follow.loading=!1,t.follow.inverted=n.result.state,e.showModal({content:"取消关注成功",showCancel:!1})}}))},complete:function(){t.follow.loading=!1}})):(this.follow.loading=!0,i.default.call({name:"updataFolow",data:{action:"add",token:this.token,_id:this.shelfid},success:function(n){console.log(n),t.follow.loading=!1,t.follow.inverted=n.result.state,e.showModal({content:"关注成功",showCancel:!1})}})))},drawPoster:function(){var t=this;this.isCanvas=!0,e.showLoading({title:"生成中",mask:!0});var n=wx.createSelectorQuery();n.select("#myPoster").fields({node:!0,size:!0}).exec(function(){var n=r(o.default.mark((function n(a){var s,l,c,r,u,f,d,h;return o.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return s=a[0].node,l=s.getContext("2d"),c=e.getSystemInfoSync().pixelRatio,s.width=a[0].width*c,s.height=a[0].height*c,l.scale(c,c),l.fillStyle="#ffffff",l.fillRect(0,30,350,750),l.fillStyle="black",l.fontSize=20,l.fillText("用户名："+t.shelfInfo.ownerinfo.nickName,70,50),l.fontSize=20,l.fillText("书房名："+t.shelfInfo.name,70,65),l.fontSize=20,l.fillText("地址："+t.shelfInfo.address,70,80),r=s.createImage(),r.onload=function(e){l.drawImage(r,10,35,50,50)},r.src=t.shelfInfo.ownerinfo.avatarUrl,u=Math.min(t.books.length,9),f=0,d=function n(){var o=t.books[f];console.log(t.books),t.books.length<1?e.showModal({content:"无图书分享",showCancel:!1}):e.getImageInfo({src:o.cover_url,success:function(t){var i=s.createImage();i.onload=function(){var t=115*Math.floor(f%3)+10,a=165*Math.floor(f/3)+100;l.drawImage(i,t,a,100,150),l.fontSize=16,l.fillText(o.title,t,a+165,100),f<u-1?(f++,n()):(console.log("全部封面加载结束"),e.hideLoading(),e.canvasToTempFilePath({canvas:s,success:function(t){e.previewImage({current:t.tempFilePath,urls:[t.tempFilePath]})},fail:function(e){console.log(e)}}))},i.src=t.path}})},n.next=23,i.default.call({name:"getwxacode",data:{scene:"sid="+t.shelfInfo._id}});case 23:h=n.sent,console.log(h),wx.getFileSystemManager().writeFileSync("".concat(wx.env.USER_DATA_PATH,"/mpcode.jpg"),e.arrayBufferToBase64(h.result.data),"base64"),e.getImageInfo({src:"".concat(wx.env.USER_DATA_PATH,"/mpcode.jpg"),success:function(e){var t=s.createImage();t.onload=function(e){l.drawImage(t,180,580,160,160),d()},t.src=e.path}});case 27:case"end":return n.stop()}}),n)})));return function(e){return n.apply(this,arguments)}}())},onShareSelected:function(e){1==e&&this.drawPoster()},onShareDismiss:function(){this.showShareMenu=!1},getShelfInfo:function(){var e=this;i.default.call({name:"bookshelfs",data:{action:"get",_id:this.shelfid},success:function(t){console.log(t.result),e.shelfInfo=t.result,e.shelfInfo.createtime?e.shelfInfo.createtime=a.default.timestampToTime(e.shelfInfo.createtime):e.shelfInfo.createtime=""}})},requestBookList:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;t&&!this.canloadmore||i.default.call({name:"books",data:{action:"listbyshelf",shelfid:this.shelfid,start:t},success:function(n){e.canloadmore=n.result.length>=9,e.books=t?e.books.concat(n.result):n.result}})},btnDeleteBook:function(t){var n=this;console.log(t.currentTarget.dataset.id),e.showActionSheet({itemList:["置顶","删除"],success:function(e){0==e.tapIndex?i.default.call({name:"books",data:{action:"movetop",bookid:t.currentTarget.dataset.id},success:function(e){n.requestBookList()}}):1==e.tapIndex&&i.default.call({name:"books",data:{action:"delete",shelfid:n.shelfid,bookid:t.currentTarget.dataset.id},success:function(e){n.requestBookList()}})}})},btnExitEditing:function(){this.isEditing=!1},btnEnterEditing:function(){this.isEditing=!0},btnScan:function(){var t=this;e.scanCode({success:function(){var e=r(o.default.mark((function e(n){var a;return o.default.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,i.default.call({name:"ISBNQuery",data:{isbn:n.result}});case 2:return a=e.sent,e.next=5,i.default.call({name:"books",data:{action:"add",shelfid:t.shelfid,isbnid:a.result._id}});case 5:t.requestBookList();case 6:case"end":return e.stop()}}),e)})));function n(t){return e.apply(this,arguments)}return n}(),fail:function(t){console.log("扫码失败",t),e.showModal({content:"扫码失败,请重新尝试",showCancel:!1})}})}}};t.default=p}).call(this,n("543d")["default"])},5269:function(e,t,n){},"6d84":function(e,t,n){"use strict";(function(e){n("bcc6");o(n("66fd"));var t=o(n("b501"));function o(e){return e&&e.__esModule?e:{default:e}}wx.__webpack_require_UNI_MP_PLUGIN__=n,e(t.default)}).call(this,n("543d")["createPage"])},b501:function(e,t,n){"use strict";n.r(t);var o=n("3d76"),i=n("155e");for(var a in i)"default"!==a&&function(e){n.d(t,e,(function(){return i[e]}))}(a);n("f8fa");var s,l=n("f0c5"),c=Object(l["a"])(i["default"],o["b"],o["c"],!1,null,null,null,!1,o["a"],s);t["default"]=c.exports},f8fa:function(e,t,n){"use strict";var o=n("5269"),i=n.n(o);i.a}},[["6d84","common/runtime","common/vendor"]]]);