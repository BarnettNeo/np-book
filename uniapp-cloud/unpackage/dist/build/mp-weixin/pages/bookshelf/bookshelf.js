(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/bookshelf/bookshelf"],{"19c7":function(e,t,n){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var o=l(n("a34a")),i=l(n("abb0")),s=l(n("b57f")),a=n("26cb");function l(e){return e&&e.__esModule?e:{default:e}}function c(e,t,n,o,i,s,a){try{var l=e[s](a),c=l.value}catch(r){return void n(r)}l.done?t(c):Promise.resolve(c).then(o,i)}function r(e){return function(){var t=this,n=arguments;return new Promise((function(o,i){var s=e.apply(t,n);function a(e){c(s,o,i,a,l,"next",e)}function l(e){c(s,o,i,a,l,"throw",e)}a(void 0)}))}}function u(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function f(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?u(Object(n),!0).forEach((function(t){d(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):u(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function d(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var h=function(){n.e("components/pubpage").then(function(){return resolve(n("00e9"))}.bind(null,n)).catch(n.oe)},g=function(){n.e("components/pubshare").then(function(){return resolve(n("7a80"))}.bind(null,n)).catch(n.oe)},b=function(){n.e("components/pub-ui/bookcell").then(function(){return resolve(n("dd81"))}.bind(null,n)).catch(n.oe)},p={components:{pubpage:h,bookcell:b,pubshare:g},data:function(){return{title:"",isEditing:!1,shelfInfo:null,shelfid:null,canloadmore:!0,showShareMenu:!1,isBooksLen:!1,isCanvas:!1,books:[],follow:{isExi:!1,loading:!0,inverted:!1,text:"未关注"}}},computed:f({},(0,a.mapGetters)(["token"])),watch:{books:function(e){this.isBooksLen=e<1},"shelfInfo.isowner":{handler:function(e){var t=this;this.follow.isExi=!e,e||i.default.call({name:"updataFolow",data:{action:"get",token:this.token,_id:this.shelfid},success:function(e){console.log(e),t.follow.loading=!1,t.follow.inverted=e.result.state}})}},"follow.inverted":{handler:function(e){this.follow.text=e?"已关注":"未关注"}}},onLoad:function(t){this.shelfid=t.id,this.shelfid||e.navigateBack(),this.getShelfInfo(),this.requestBookList()},onReachBottom:function(){this.requestBookList(this.books[this.books.length-1]._id)},onShareAppMessage:function(){return{title:this.title,path:"/pages/me/index?scene=sid="+this.shelfInfo._id}},methods:{setFollow:function(){var t=this;this.follow.loading||(this.follow.inverted?(this.follow.loading=!0,e.showModal({content:"确定取消关注吗?",success:function(n){n.confirm&&(t.follow.loading=!0,i.default.call({name:"updataFolow",data:{action:"delete",token:t.token,_id:t.shelfid},success:function(n){console.log(n),t.follow.loading=!1,t.follow.inverted=n.result.state,e.showModal({content:"取消关注成功",showCancel:!1})}}))},complete:function(){t.follow.loading=!1}})):(this.follow.loading=!0,i.default.call({name:"updataFolow",data:{action:"add",token:this.token,_id:this.shelfid},success:function(n){console.log(n),t.follow.loading=!1,t.follow.inverted=n.result.state,e.showModal({content:"关注成功",showCancel:!1})}})))},drawPoster:function(){var t=this;this.isCanvas=!0,e.showLoading({title:"生成中",mask:!0});var n=wx.createSelectorQuery();console.log(n.select("#myPoster")),n.select("#myPoster").fields({node:!0,size:!0}).exec(function(){var n=r(o.default.mark((function n(s){var a,l,c,r,u,f,d,h,g;return o.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return a=s[0].node,l=a.getContext("2d"),c=e.getSystemInfoSync().pixelRatio,a.width=s[0].width*c,a.height=s[0].height*c,l.scale(c,c),l.fillStyle="#ffffff",l.fillRect(0,30,350,750),l.fillStyle="black",l.fontSize=20,l.fillText("用户名："+t.shelfInfo.ownerinfo.nickName,70,50),l.fontSize=20,l.fillText("书房名："+t.shelfInfo.name,70,65),l.fontSize=20,l.fillText("地址："+t.shelfInfo.address,70,80),r=a.createImage(),r.onload=function(e){l.drawImage(r,10,35,50,50)},r.src=t.shelfInfo.ownerinfo.avatarUrl,u=Math.min(t.books.length,9),f=0,d=function n(){var o=t.books[f];t.books.length<1?e.showModal({content:"无图书分享",showCancel:!1}):e.getImageInfo({src:o.cover_url,success:function(t){var i=a.createImage();i.onload=function(){var t=115*Math.floor(f%3)+10,s=165*Math.floor(f/3)+100;l.drawImage(i,t,s,100,150),l.fontSize=16,l.fillText(o.title,t,s+165,100),f<u-1?(f++,n()):(console.log("全部封面加载结束"),e.hideLoading(),e.canvasToTempFilePath({canvas:a,success:function(t){e.previewImage({current:t.tempFilePath,urls:[t.tempFilePath]})},fail:function(e){console.log(e)}}))},i.src=t.path}})},n.next=23,i.default.call({name:"getwxacode",data:{scene:"sid="+t.shelfInfo._id}});case 23:h=n.sent,console.log(h),g=wx.getFileSystemManager(),g.writeFileSync("".concat(wx.env.USER_DATA_PATH,"/mpcode.jpg"),e.arrayBufferToBase64(h.result.data),"base64"),e.getImageInfo({src:"".concat(wx.env.USER_DATA_PATH,"/mpcode.jpg"),success:function(e){console.log("二维码",e);var t=a.createImage();t.onload=function(e){l.drawImage(t,180,580,160,160),d()},t.src=e.path}});case 28:case"end":return n.stop()}}),n)})));return function(e){return n.apply(this,arguments)}}())},onShareSelected:function(e){1==e&&this.drawPoster()},onShareDismiss:function(){this.showShareMenu=!1},getShelfInfo:function(){var e=this;i.default.call({name:"bookshelfs",data:{action:"get",_id:this.shelfid},success:function(t){console.log(t.result),e.shelfInfo=t.result,e.shelfInfo.createtime?e.shelfInfo.createtime=s.default.timestampToTime(e.shelfInfo.createtime):e.shelfInfo.createtime=""}})},requestBookList:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;t&&!this.canloadmore||i.default.call({name:"books",data:{action:"listbyshelf",shelfid:this.shelfid,start:t},success:function(n){e.canloadmore=n.result.length>=9,e.books=t?e.books.concat(n.result):n.result}})},btnDeleteBook:function(t){var n=this;console.log(t.currentTarget.dataset.id),e.showActionSheet({itemList:["置顶","删除"],success:function(e){0==e.tapIndex?i.default.call({name:"books",data:{action:"movetop",bookid:t.currentTarget.dataset.id},success:function(e){n.requestBookList()}}):1==e.tapIndex&&i.default.call({name:"books",data:{action:"delete",shelfid:n.shelfid,bookid:t.currentTarget.dataset.id},success:function(e){n.requestBookList()}})}})},btnExitEditing:function(){this.isEditing=!1},btnEnterEditing:function(){this.isEditing=!0},btnScan:function(){var t=this;e.scanCode({success:function(){var n=r(o.default.mark((function n(s){return o.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return console.log("扫码结果",s),n.next=3,i.default.call({name:"ISBNQuery",data:{isbn:s.result,shelfid:t.shelfid},success:function(n){console.log("doubanbook",n),n.result.state?i.default.call({name:"books",data:{action:"add",shelfid:t.shelfid,isbnid:n.result._id}}):e.showModal({content:n.result.msg,showCancel:!1})}});case 3:n.sent,t.requestBookList();case 5:case"end":return n.stop()}}),n)})));function s(e){return n.apply(this,arguments)}return s}(),fail:function(t){console.log("扫码失败",t),e.showModal({content:"扫码失败,请重新尝试",showCancel:!1})}})}}};t.default=p}).call(this,n("543d")["default"])},2392:function(e,t,n){},5731:function(e,t,n){"use strict";var o=n("2392"),i=n.n(o);i.a},6360:function(e,t,n){"use strict";(function(e){n("efbb");o(n("66fd"));var t=o(n("716a"));function o(e){return e&&e.__esModule?e:{default:e}}wx.__webpack_require_UNI_MP_PLUGIN__=n,e(t.default)}).call(this,n("543d")["createPage"])},"716a":function(e,t,n){"use strict";n.r(t);var o=n("e3fc"),i=n("d74f");for(var s in i)"default"!==s&&function(e){n.d(t,e,(function(){return i[e]}))}(s);n("5731");var a,l=n("f0c5"),c=Object(l["a"])(i["default"],o["b"],o["c"],!1,null,null,null,!1,o["a"],a);t["default"]=c.exports},d74f:function(e,t,n){"use strict";n.r(t);var o=n("19c7"),i=n.n(o);for(var s in o)"default"!==s&&function(e){n.d(t,e,(function(){return o[e]}))}(s);t["default"]=i.a},e3fc:function(e,t,n){"use strict";n.d(t,"b",(function(){return i})),n.d(t,"c",(function(){return s})),n.d(t,"a",(function(){return o}));var o={uniTag:function(){return n.e("node-modules/@dcloudio/uni-ui/lib/uni-tag/uni-tag").then(n.bind(null,"feb9"))}},i=function(){var e=this,t=e.$createElement;e._self._c;e._isMounted||(e.e0=function(t){e.showShareMenu=!0})},s=[]}},[["6360","common/runtime","common/vendor"]]]);