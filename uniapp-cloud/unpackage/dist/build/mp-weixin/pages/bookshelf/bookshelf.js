(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/bookshelf/bookshelf"],{"0ed5":function(e,t,n){},"2eb6":function(e,t,n){"use strict";(function(e){n("ebae"),n("a9ff");o(n("66fd"));var t=o(n("86f6"));function o(e){return e&&e.__esModule?e:{default:e}}wx.__webpack_require_UNI_MP_PLUGIN__=n,e(t.default)}).call(this,n("543d")["createPage"])},3611:function(e,t,n){"use strict";var o;n.d(t,"b",(function(){return s})),n.d(t,"c",(function(){return a})),n.d(t,"a",(function(){return o}));var s=function(){var e=this,t=e.$createElement;e._self._c;e._isMounted||(e.e0=function(t){e.showShareMenu=!0})},a=[]},4630:function(e,t,n){"use strict";n.r(t);var o=n("76f8"),s=n.n(o);for(var a in o)"default"!==a&&function(e){n.d(t,e,(function(){return o[e]}))}(a);t["default"]=s.a},"76f8":function(e,t,n){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var o=i(n("a34a")),s=i(n("71b7")),a=i(n("adf8"));n("26cb");function i(e){return e&&e.__esModule?e:{default:e}}function c(e,t,n,o,s,a,i){try{var c=e[a](i),r=c.value}catch(l){return void n(l)}c.done?t(r):Promise.resolve(r).then(o,s)}function r(e){return function(){var t=this,n=arguments;return new Promise((function(o,s){var a=e.apply(t,n);function i(e){c(a,o,s,i,r,"next",e)}function r(e){c(a,o,s,i,r,"throw",e)}i(void 0)}))}}var l=function(){n.e("components/pubpage").then(function(){return resolve(n("34c9"))}.bind(null,n)).catch(n.oe)},u=function(){n.e("components/pubshare").then(function(){return resolve(n("7c7c"))}.bind(null,n)).catch(n.oe)},f=function(){n.e("components/pubfooter").then(function(){return resolve(n("7aef"))}.bind(null,n)).catch(n.oe)},d=function(){n.e("components/pubfolow").then(function(){return resolve(n("a00d"))}.bind(null,n)).catch(n.oe)},h=function(){n.e("components/pub-ui/bookcell").then(function(){return resolve(n("fe35"))}.bind(null,n)).catch(n.oe)},p={components:{pubpage:l,bookcell:h,pubshare:u,pubfooter:f,pubfolow:d},data:function(){return{title:"",isEditing:!1,shelfInfo:null,shelfid:null,canloadmore:!0,showShareMenu:!1,isBooksLen:!1,isCanvas:!1,books:[],isExi:!1}},watch:{books:function(e){this.isBooksLen=e<1},"shelfInfo.isowner":{handler:function(e){this.isExi=!e}}},onLoad:function(t){this.shelfid=t.id,this.shelfid||e.navigateBack(),this.getShelfInfo(),this.requestBookList()},onShareAppMessage:function(){return{title:this.title,path:"/pages/me/index?scene=sid="+this.shelfInfo._id}},methods:{openPage:function(t){this.shelfInfo.isowner||e.navigateTo({url:"../../orderpage/index/index?id="+t})},drawPoster:function(){var t=this;this.isCanvas=!0,e.showLoading({title:"生成中",mask:!0});var n=wx.createSelectorQuery();console.log(n.select("#myPoster")),n.select("#myPoster").fields({node:!0,size:!0}).exec(function(){var n=r(o.default.mark((function n(a){var i,c,r,l,u,f,d,h,p;return o.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return i=a[0].node,c=i.getContext("2d"),r=e.getSystemInfoSync().pixelRatio,i.width=a[0].width*r,i.height=a[0].height*r,c.scale(r,r),c.fillStyle="#ffffff",c.fillRect(0,30,350,750),c.fillStyle="black",c.fontSize=20,c.fillText("用户名："+t.shelfInfo.ownerinfo.nickName,70,50),c.fontSize=20,c.fillText("书房名："+t.shelfInfo.name,70,65),c.fontSize=20,c.fillText("地址："+t.shelfInfo.address,70,80),l=i.createImage(),l.onload=function(e){c.drawImage(l,10,35,50,50)},l.src=t.shelfInfo.ownerinfo.avatarUrl,u=Math.min(t.books.length,9),f=0,d=function n(){var o=t.books[f];t.books.length<1?e.showModal({content:"无图书分享",showCancel:!1}):e.getImageInfo({src:o.cover_url,success:function(t){var s=i.createImage();s.onload=function(){var t=115*Math.floor(f%3)+10,a=165*Math.floor(f/3)+100;c.drawImage(s,t,a,100,150),c.fontSize=16,c.fillText(o.title,t,a+165,100),f<u-1?(f++,n()):(console.log("全部封面加载结束"),e.hideLoading(),e.canvasToTempFilePath({canvas:i,success:function(t){e.previewImage({current:t.tempFilePath,urls:[t.tempFilePath]})},fail:function(e){console.log(e)}}))},s.src=t.path}})},n.next=23,s.default.call({name:"getwxacode",data:{scene:"sid="+t.shelfInfo._id}});case 23:h=n.sent,console.log(h),p=wx.getFileSystemManager(),p.writeFileSync("".concat(wx.env.USER_DATA_PATH,"/mpcode.jpg"),e.arrayBufferToBase64(h.result.data),"base64"),e.getImageInfo({src:"".concat(wx.env.USER_DATA_PATH,"/mpcode.jpg"),success:function(e){console.log("二维码",e);var t=i.createImage();t.onload=function(e){c.drawImage(t,180,580,160,160),d()},t.src=e.path}});case 28:case"end":return n.stop()}}),n)})));return function(e){return n.apply(this,arguments)}}())},onShareSelected:function(e){console.log("分享点击",e),1==e&&this.drawPoster()},onShareDismiss:function(){console.log("取消"),this.showShareMenu=!1},getShelfInfo:function(){var e=this;s.default.call({name:"bookshelfs",data:{action:"get",_id:this.shelfid},success:function(t){console.log(t.result),e.shelfInfo=t.result,e.shelfInfo.createtime?e.shelfInfo.createtime=a.default.timestampToTime(e.shelfInfo.createtime):e.shelfInfo.createtime=""}})},requestBookList:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;t&&!this.canloadmore||s.default.call({name:"books",data:{action:"listbyshelf",shelfid:this.shelfid,start:t},success:function(n){e.canloadmore=n.result.length>=9,e.books=t?e.books.concat(n.result):n.result}})},btnDeleteBook:function(t){var n=this;console.log(t.currentTarget.dataset.id),e.showActionSheet({itemList:["置顶","删除"],success:function(e){0==e.tapIndex?s.default.call({name:"books",data:{action:"movetop",bookid:t.currentTarget.dataset.id},success:function(e){n.requestBookList()}}):1==e.tapIndex&&s.default.call({name:"books",data:{action:"delete",shelfid:n.shelfid,bookid:t.currentTarget.dataset.id},success:function(e){n.requestBookList()}})}})},btnExitEditing:function(){this.isEditing=!1},btnEnterEditing:function(){this.isEditing=!0},btnScan:function(){var t=this;e.showModal({content:"请您通过书籍后面的条形码进行扫码添加书籍哦",success:function(n){n.confirm&&e.scanCode({success:function(){var n=r(o.default.mark((function n(a){return o.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return console.log("扫码结果",a),n.next=3,s.default.call({name:"ISBNQuery",data:{isbn:a.result,shelfid:t.shelfid},success:function(){var n=r(o.default.mark((function n(a){return o.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:if(console.log("doubanbook",a),!a.result.state){n.next=6;break}return n.next=4,s.default.call({name:"books",data:{action:"add",shelfid:t.shelfid,isbnid:a.result.resData._id}});case 4:n.next=7;break;case 6:e.showModal({content:a.result.msg,showCancel:!1});case 7:t.requestBookList();case 8:case"end":return n.stop()}}),n)})));function a(e){return n.apply(this,arguments)}return a}()});case 3:n.sent;case 4:case"end":return n.stop()}}),n)})));function a(e){return n.apply(this,arguments)}return a}(),fail:function(t){console.log("扫码失败",t),e.showModal({content:"扫码失败,请重新尝试",showCancel:!1})}})}})}}};t.default=p}).call(this,n("543d")["default"])},"86f6":function(e,t,n){"use strict";n.r(t);var o=n("3611"),s=n("4630");for(var a in s)"default"!==a&&function(e){n.d(t,e,(function(){return s[e]}))}(a);n("b8f2");var i,c=n("f0c5"),r=Object(c["a"])(s["default"],o["b"],o["c"],!1,null,null,null,!1,o["a"],i);t["default"]=r.exports},b8f2:function(e,t,n){"use strict";var o=n("0ed5"),s=n.n(o);s.a}},[["2eb6","common/runtime","common/vendor"]]]);