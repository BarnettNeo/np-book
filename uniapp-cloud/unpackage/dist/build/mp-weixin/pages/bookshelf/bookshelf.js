(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/bookshelf/bookshelf"],{"1c19":function(e,t,n){"use strict";var o;n.d(t,"b",(function(){return a})),n.d(t,"c",(function(){return s})),n.d(t,"a",(function(){return o}));var a=function(){var e=this,t=e.$createElement;e._self._c;e._isMounted||(e.e0=function(t){e.showShareMenu=!0})},s=[]},3198:function(e,t,n){"use strict";var o=n("8e18"),a=n.n(o);a.a},"6ca5":function(e,t,n){"use strict";(function(e){n("8a37"),n("a9ff");o(n("66fd"));var t=o(n("e62f"));function o(e){return e&&e.__esModule?e:{default:e}}wx.__webpack_require_UNI_MP_PLUGIN__=n,e(t.default)}).call(this,n("543d")["createPage"])},"8e18":function(e,t,n){},"9ac6":function(e,t,n){"use strict";n.r(t);var o=n("c8c9"),a=n.n(o);for(var s in o)"default"!==s&&function(e){n.d(t,e,(function(){return o[e]}))}(s);t["default"]=a.a},c8c9:function(e,t,n){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var o=i(n("a34a")),a=i(n("d055")),s=i(n("e3ad"));n("26cb");function i(e){return e&&e.__esModule?e:{default:e}}function c(e,t,n,o,a,s,i){try{var c=e[s](i),r=c.value}catch(l){return void n(l)}c.done?t(r):Promise.resolve(r).then(o,a)}function r(e){return function(){var t=this,n=arguments;return new Promise((function(o,a){var s=e.apply(t,n);function i(e){c(s,o,a,i,r,"next",e)}function r(e){c(s,o,a,i,r,"throw",e)}i(void 0)}))}}var l=function(){n.e("components/pubpage").then(function(){return resolve(n("9d31"))}.bind(null,n)).catch(n.oe)},u=function(){n.e("components/pubshare").then(function(){return resolve(n("a41f"))}.bind(null,n)).catch(n.oe)},f=function(){n.e("components/pubfooter").then(function(){return resolve(n("a238"))}.bind(null,n)).catch(n.oe)},d=function(){n.e("components/pubfolow").then(function(){return resolve(n("aa9b"))}.bind(null,n)).catch(n.oe)},h=function(){n.e("components/pub-ui/bookcell").then(function(){return resolve(n("0486"))}.bind(null,n)).catch(n.oe)},p={components:{pubpage:l,bookcell:h,pubshare:u,pubfooter:f,pubfolow:d},data:function(){return{title:"",isEditing:!1,shelfInfo:null,shelfid:null,canloadmore:!0,showShareMenu:!1,isBooksLen:!1,isCanvas:!1,books:[],isExi:!1}},watch:{books:function(e){this.isBooksLen=e<1},"shelfInfo.isowner":{handler:function(e){this.isExi=!e}}},onLoad:function(t){this.shelfid=t.id,this.shelfid||e.navigateBack(),this.getShelfInfo(),this.requestBookList()},onShareAppMessage:function(){return{title:this.title,path:"/pages/me/index?scene=sid="+this.shelfInfo._id}},methods:{openPage:function(t){this.shelfInfo.isowner||e.navigateTo({url:"../../orderpage/index/index?id="+t})},drawPoster:function(){var t=this;this.isCanvas=!0,e.showLoading({title:"生成中",mask:!0});var n=wx.createSelectorQuery();console.log(n.select("#myPoster")),n.select("#myPoster").fields({node:!0,size:!0}).exec(function(){var n=r(o.default.mark((function n(s){var i,c,r,l,u,f,d,h,p;return o.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return i=s[0].node,c=i.getContext("2d"),r=e.getSystemInfoSync().pixelRatio,i.width=s[0].width*r,i.height=s[0].height*r,c.scale(r,r),c.fillStyle="#ffffff",c.fillRect(0,30,350,750),c.fillStyle="black",c.fontSize=20,c.fillText("用户名："+t.shelfInfo.ownerinfo.nickName,70,50),c.fontSize=20,c.fillText("书房名："+t.shelfInfo.name,70,65),c.fontSize=20,c.fillText("地址："+t.shelfInfo.address,70,80),l=i.createImage(),l.onload=function(e){c.drawImage(l,10,35,50,50)},l.src=t.shelfInfo.ownerinfo.avatarUrl,u=Math.min(t.books.length,9),f=0,d=function n(){var o=t.books[f];t.books.length<1?e.showModal({content:"无图书分享",showCancel:!1}):e.getImageInfo({src:o.cover_url,success:function(t){var a=i.createImage();a.onload=function(){var t=115*Math.floor(f%3)+10,s=165*Math.floor(f/3)+100;c.drawImage(a,t,s,100,150),c.fontSize=16,c.fillText(o.title,t,s+165,100),f<u-1?(f++,n()):(console.log("全部封面加载结束"),e.hideLoading(),e.canvasToTempFilePath({canvas:i,success:function(t){e.previewImage({current:t.tempFilePath,urls:[t.tempFilePath]})},fail:function(e){console.log(e)}}))},a.src=t.path}})},n.next=23,a.default.call({name:"getwxacode",data:{scene:"sid="+t.shelfInfo._id}});case 23:h=n.sent,console.log(h),p=wx.getFileSystemManager(),p.writeFileSync("".concat(wx.env.USER_DATA_PATH,"/mpcode.jpg"),e.arrayBufferToBase64(h.result.data),"base64"),e.getImageInfo({src:"".concat(wx.env.USER_DATA_PATH,"/mpcode.jpg"),success:function(e){console.log("二维码",e);var t=i.createImage();t.onload=function(e){c.drawImage(t,180,580,160,160),d()},t.src=e.path}});case 28:case"end":return n.stop()}}),n)})));return function(e){return n.apply(this,arguments)}}())},onShareSelected:function(e){console.log("分享点击",e),1==e&&this.drawPoster()},onShareDismiss:function(){console.log("取消"),this.showShareMenu=!1},getShelfInfo:function(){var e=this;a.default.call({name:"bookshelfs",data:{action:"get",_id:this.shelfid},success:function(t){console.log(t.result),e.shelfInfo=t.result,e.shelfInfo.createtime?e.shelfInfo.createtime=s.default.timestampToTime(e.shelfInfo.createtime):e.shelfInfo.createtime=""}})},requestBookList:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;t&&!this.canloadmore||a.default.call({name:"books",data:{action:"listbyshelf",shelfid:this.shelfid,start:t},success:function(n){e.canloadmore=n.result.length>=9,e.books=t?e.books.concat(n.result):n.result}})},btnDeleteBook:function(t){var n=this;console.log(t.currentTarget.dataset.id),e.showActionSheet({itemList:["置顶","删除"],success:function(e){0==e.tapIndex?a.default.call({name:"books",data:{action:"movetop",bookid:t.currentTarget.dataset.id},success:function(e){n.requestBookList()}}):1==e.tapIndex&&a.default.call({name:"books",data:{action:"delete",shelfid:n.shelfid,bookid:t.currentTarget.dataset.id},success:function(e){n.requestBookList()}})}})},btnExitEditing:function(){this.isEditing=!1},btnEnterEditing:function(){this.isEditing=!0},btnScan:function(){var t=this;e.scanCode({success:function(){var n=r(o.default.mark((function n(s){return o.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return console.log("扫码结果",s),n.next=3,a.default.call({name:"ISBNQuery",data:{isbn:s.result,shelfid:t.shelfid},success:function(){var n=r(o.default.mark((function n(s){return o.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:if(console.log("doubanbook",s),!s.result.state){n.next=6;break}return n.next=4,a.default.call({name:"books",data:{action:"add",shelfid:t.shelfid,isbnid:s.result.resData._id}});case 4:n.next=7;break;case 6:e.showModal({content:s.result.msg,showCancel:!1});case 7:t.requestBookList();case 8:case"end":return n.stop()}}),n)})));function s(e){return n.apply(this,arguments)}return s}()});case 3:n.sent;case 4:case"end":return n.stop()}}),n)})));function s(e){return n.apply(this,arguments)}return s}(),fail:function(t){console.log("扫码失败",t),e.showModal({content:"扫码失败,请重新尝试",showCancel:!1})}})}}};t.default=p}).call(this,n("543d")["default"])},e62f:function(e,t,n){"use strict";n.r(t);var o=n("1c19"),a=n("9ac6");for(var s in a)"default"!==s&&function(e){n.d(t,e,(function(){return a[e]}))}(s);n("3198");var i,c=n("f0c5"),r=Object(c["a"])(a["default"],o["b"],o["c"],!1,null,null,null,!1,o["a"],i);t["default"]=r.exports}},[["6ca5","common/runtime","common/vendor"]]]);